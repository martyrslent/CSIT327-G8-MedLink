{% extends 'admin_dashboard.html' %}
{% load static %}

{% block title %}User Management{% endblock %}

{% block style %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

/* Sidebar (cleaned & robust) */
.sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 220px;
    background: #ffffff;
    padding: 30px 20px;
    display: flex;
    flex-direction: column;
    gap: 25px;
    box-sizing: border-box;
    border-right: 1px solid rgba(0,0,0,0.08);
    z-index: 2;
    overflow: hidden;
    font-family: 'Poppins', sans-serif;
}
.sidebar::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url("{% static 'main/img/womandoctor.png' %}") no-repeat center center;
    background-size: cover;
    opacity: 0.28;
    pointer-events: none;
    z-index: 0;
}
.sidebar .logo img {
    width: 150px;
    display: block;
    margin: 0 auto 30px auto;
    position: relative;
    z-index: 1;
}
.sidebar nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
    position: relative;
    z-index: 1;
}
.sidebar nav ul li a {
    color: #fff;
    text-decoration: none;
    padding: 10px 14px;
    border-radius: 10px;
    display: block;
    font-weight: 600;
    transition: background 0.25s ease, transform 0.22s ease, box-shadow 0.25s ease;
    background: #ad0505;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
    position: relative;
    z-index: 1;
    font-family: 'Poppins', sans-serif;
}
.sidebar nav ul li a:hover,
.sidebar nav ul li a:focus {
    background: linear-gradient(to right, #ff7b00, #d10000);
    color: #fff;
    transform: translateX(6px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18);
    outline: none;
}
.sidebar nav ul li a.active {
    background: linear-gradient(to right, #d10000, #a30000);
    box-shadow: 0 8px 20px rgba(0,0,0,0.20);
    transform: translateX(3px);
}

/* Match Admin Dashboard UI: white cards, shadows, button system, table striping */
.user-management-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    align-items: start;
}
@media (min-width: 768px) {
    .user-management-grid {
        grid-template-columns: 1fr 1fr;
    }
}
.card.full {
    background: #ffffff;
    border-radius: 14px;
    padding: 18px;
    box-shadow: 0 10px 26px rgba(0,0,0,0.18);
    color: #222;
    font-family: 'Poppins', sans-serif;
}
h1.page-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #ffffff;
    margin-left: 4px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-family: 'Poppins', sans-serif;
}
.status-tag {
    background: #8d0000b4;
    color: white;
    padding: 7px 13px;
    border-radius: 8px;
    font-size: 1.5rem;
    font-weight: 600;
    font-family: 'Poppins', sans-serif;
}

/* Tables: matching admin dashboard style, reduced row height and button alignment */
.user-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 0.95rem;
    font-family: 'Poppins', sans-serif;
}
.user-table thead th {
    padding: 12px 10px;
    text-align: left;
    font-weight: 700;
    border-bottom: 2px solid rgba(200,0,0,0.08);
    background: rgba(255, 255, 255, 1);
    font-family: 'Poppins', sans-serif;
}
.user-table th, .user-table td {
    padding: 12px 10px;
    text-align: left;
    vertical-align: middle;
    font-family: 'Poppins', sans-serif;
}
.user-table tbody tr {
    height: 50px; /* Reduced row height */
}
.user-table tbody tr:nth-child(odd) { background: rgba(245, 245, 245, 0.92); }
.user-table tbody tr:nth-child(even) { background: rgba(255, 250, 250, 0.96); }
.user-table tbody tr:hover { background: rgba(255, 238, 238, 0.96); }

/* Badges tuned to dashboard palette */
.status-badge { display:inline-block; padding:6px 8px; border-radius:6px; font-weight:700; font-size:0.85rem; font-family: 'Poppins', sans-serif; }
.doctor-badge { background:#d4edda; color:#155724; }
.doctor-notin-badge { background:#f8d7da; color:#721c24; }
.patient-badge { background:#fff3cd; color:#856404; }

/* Reuse admin-dashboard button system: .btn-action and variants */
.action-btn, .btn-action {
    display: inline-block;
    padding: 8px 12px;
    border-radius: 10px;
    color: #fff !important;
    text-decoration: none !important;
    font-size: 0.9rem;
    font-weight: 700;
    box-shadow: 0 6px 14px rgba(0,0,0,0.12);
    transition: transform 0.18s ease, box-shadow 0.18s ease;
    vertical-align: middle;
    border: none;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
}
.action-btn:hover, .btn-action:hover { transform: translateY(-3px); box-shadow: 0 10px 22px rgba(0,0,0,0.14); }
.btn-approve { background: linear-gradient(90deg, #ff9a3d, #ff7b00); }
.btn-complete { background: linear-gradient(90deg, #34c38f, #0bb07a); }
.btn-manage { background: linear-gradient(90deg, #6c7cff, #4a5dd6); }
.btn-addstaff { background: linear-gradient(90deg, #ff5100ff, #af0000ff); }
.delete-btn { background: linear-gradient(90deg, #dc3545, #c82333); }
.toggle-btn { background: linear-gradient(90deg, #fdbd5cff, #ee9b00ff); color: #ffffffff !important; }
.toggle-btn-inactive { background: linear-gradient(90deg, #d1c27d, #b8a97d); color: #ffffff !important; } /* Deeper yellow-grayish */

/* Button container for horizontal alignment */
.button-container {
    display: flex;
    gap: 8px;
    justify-content: flex-start;
}

/* Adjust action column width */
.user-table th:nth-child(4), .user-table td:nth-child(4) {
    width: 220px;
}

/* Place the Add New Staff button below the doctors table to align both tables at top */
.add-staff-container { margin-top: 14px; margin-right: 30px;}
.add-staff-container .btn-action { width: 100%; display: block; text-align:center; }

/* Messages styling to match cards */
.messages-container p {
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 12px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.06);
    font-family: 'Poppins', sans-serif;
}

@media (max-width: 767px) {
    .add-staff-container .btn-action { width: 100%; }
}
</style>
{% endblock %}

{% block content %}
<h1 class="page-title">
    User Management
    <span class="status-tag">Total User Count: {{ total_users|default:0 }}</span>
</h1>

{% if messages %}
    <div class="messages-container">
        {% for message in messages %}
            <p style="background: {% if 'error' in message.tags %}#f8d7da{% else %}#d4edda{% endif %}; color: {% if 'error' in message.tags %}#721c24{% else %}#155724{% endif %};">
                {{ message }}
            </p>
        {% endfor %}
    </div>
{% endif %}

<div class="user-management-grid">
    <div class="card full">
        <h3>Medical Staff (Doctors: {{ doctors|length }})</h3>
        {% if doctors %}
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doctor in doctors %}
                        <tr>
                            <td>{{ doctor.first_name }} {{ doctor.last_name }}</td>
                            <td>{{ doctor.email }}</td>
                            <td>
                                {% if doctor.is_in %}
                                    <span class="status-badge doctor-badge">Ready</span>
                                {% else %}
                                    <span class="status-badge doctor-notin-badge">Away</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if request.session.role == "superadmin" %}
                                    <div class="button-container">
                                        <a href="{% url 'edit_user' doctor.id %}" class="action-btn btn-action btn-manage">Edit</a>
                                        <form method="POST" action="{% url 'toggle_is_in' doctor.id %}" style="display:inline;">
                                            {% csrf_token %}
                                            {% if doctor.is_in %}
                                                <button type="submit" class="action-btn toggle-btn-inactive">Inactive</button>
                                            {% else %}
                                                <button type="submit" class="action-btn toggle-btn">Active</button>
                                            {% endif %}
                                        </form>
                                        <form method="POST" action="{% url 'delete_user' doctor.id %}" style="display:inline;" onsubmit="return confirm('Are you absolutely sure you want to permanently delete Dr. {{ doctor.last_name }}?');">
                                            {% csrf_token %}
                                            <button type="submit" class="action-btn delete-btn">Delete</button>
                                        </form>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="add-staff-container">
                <a class="btn-action btn-addstaff" href="{% url 'register_admin' %}">+ Add New Staff Member</a>
            </div>
        {% else %}
            <p>No doctors currently registered.</p>
            <div class="add-staff-container">
                <a class="btn-action btn-manage" href="{% url 'register_admin' %}">+ Add New Staff Member</a>
            </div>
        {% endif %}
    </div>

    <div class="card full">
        <h3>Registered Patients ({{ patients|length }})</h3>
        {% if patients %}
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for patient in patients %}
                        <tr>
                            <td>{{ patient.first_name }} {{ patient.last_name }}</td>
                            <td>{{ patient.email }}</td>
                            <td><span class="status-badge patient-badge">Patient</span></td>
                            <td>
                                <div class="button-container">
                                    {% if request.session.role == "superadmin" or request.session.role == "admin" %}
                                        <a href="{% url 'edit_user' patient.id %}" class="action-btn btn-action btn-manage">Edit</a>
                                    {% endif %}
                                    {% if request.session.role == "superadmin" %}
                                        <form method="POST" action="{% url 'delete_user' patient.id %}" style="display:inline;" onsubmit="return confirm('Are you absolutely sure you want to permanently delete {{ patient.first_name }} {{ patient.last_name }}? This action cannot be undone.');">
                                            {% csrf_token %}
                                            <button type="submit" class="action-btn delete-btn">Delete</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No regular patients currently registered.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
