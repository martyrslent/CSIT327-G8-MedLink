{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>User Dashboard</title>
  
  <link rel="stylesheet" href="{% static 'main/css/admin_dashboard.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    /* --- Unified User Theme (red / orange / white) --- */
    :root {
      --bg: #ffffff;
      --panel: #c31432;
      --card: #c31432;
      --accent: #e63946;
      --accent-2: #ff8c42;
      --text: #1a1a1a;
      --muted: #555;
      --glass: #ffffff;
      --shadow: 0 18px 48px rgba(0,0,0,0.12);
    }

    body {
      background: #ffffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #1a1a1a;
    }
    
    .dashboard-wrap { display: flex; min-height: 100vh; }
    .content { flex: 1; padding: 30px; position: relative; overflow: hidden; }
    .content::before {
      content:""; position:absolute; inset:0;
      background: radial-gradient(circle at 15% 35%, rgba(255,255,255,0.05), transparent 40%);
      pointer-events:none; z-index:0;
    }
    .content > * { position: relative; z-index:1; }

    /* 1. TOP NAV BAR */
    .top-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #ffffff;
        padding: 18px 26px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        margin-bottom: 26px;
        border: 1px solid #f1f1f1;
      animation: fadeIn 0.4s ease;
    }

    .welcome-section h2 { margin: 0; font-size: 1.6rem; color: #111; }
    .welcome-section p { margin: 6px 0 0; color: #555; font-size: 0.95rem; }

    .header-actions { display: flex; align-items: center; gap: 18px; flex-wrap: wrap; }

    /* Bell Icon & Dropdown */
    .notif-wrapper { position: relative; }
    
    .notif-btn {
        background: none; border: none; font-size: 1.4rem; cursor: pointer;
        color: #444; position: relative; transition: color 0.3s;
    }
    .notif-btn:hover { color: var(--accent); }

    .notif-badge {
        position: absolute; top: -2px; right: -2px;
        width: 9px; height: 9px; background: #dc3545;
        border-radius: 50%; border: 2px solid white;
    }

    .notif-dropdown {
        display: none;
        position: absolute; right: 0; top: 45px;
        width: 300px; background: #ffffff;
        border-radius: 12px; box-shadow: 0 18px 40px rgba(0,0,0,0.12);
        z-index: 1000; overflow: hidden; border: 1px solid #f1f1f1;
        animation: dropdownFade .2s ease;
    }
    
    .notif-header {
        padding: 12px 15px; background: #f8f8f8; border-bottom: 1px solid #eee;
        font-weight: bold; color: #444; font-size: 0.9rem;
    }

    .notif-item {
        padding: 15px; border-bottom: 1px solid #f2f2f2;
        font-size: 0.9rem; color: #333; display: flex; flex-direction: column; gap: 4px;
    }
    .notif-item:last-child { border-bottom: none; }
    .notif-item:hover { background-color: #fafafa; }
    
    .notif-status { font-weight: bold; font-size: 0.85rem; text-transform: uppercase; }
    .status-approved-text { color: #28a745; }
    .status-cancelled-text { color: #dc3545; }
    .status-pending-text { color: #ff8c42; }

    .notif-empty { padding: 20px; text-align: center; color: #999; font-style: italic; }

    /* Action Button */
    .btn-book-new { display: none; }

    /* Stat Cards */
    .stats-container { display: flex; gap: 20px; margin-bottom: 26px; flex-wrap: wrap; }
    .stat-box {
        flex: 1; min-width: 240px;
        background: linear-gradient(135deg, #c31432, #ef473a); padding: 22px; border-radius: 16px;
        box-shadow: 0 18px 40px rgba(0,0,0,0.15); display: flex;
        justify-content: space-between; align-items: center;
        border-left: 5px solid transparent;
        border: 1px solid rgba(255,255,255,0.15);
        transition: transform 0.2s, box-shadow 0.25s;
        animation: fadeInUp 0.35s ease;
        color: #fff;
    }
    .stat-box:hover { transform: translateY(-4px); box-shadow: 0 18px 44px rgba(0,0,0,0.25); }
    .stat-box.pending { border-left-color: #ffc107; }
    .stat-box.completed { border-left-color: #28a745; }
    .stat-box.total { border-left-color: #ffffff; }

    .stat-info h4 { margin: 0 0 5px; font-size: 1rem; color: #ffe5e5; font-weight: 600; }
    .stat-info .count { font-size: 2rem; font-weight: 800; color: #ffffff; margin: 0; }
    .stat-link {
        width: 40px; height: 40px; border-radius: 12px; background: rgba(255,255,255,0.08);
        display: flex; align-items: center; justify-content: center;
        color: #f7f5f2; text-decoration: none; transition: 0.3s;
    }
    .stat-link:hover { background: rgba(255,255,255,0.16); color: var(--accent-2); }

    /* Appointment Cards */
    .section-header { display:flex; justify-content: space-between; align-items:center; gap:12px; margin-bottom: 14px; flex-wrap: wrap; }
    .section-title { font-size: 1.3rem; color: #111; font-weight: 700; letter-spacing: .2px; margin:0; }
    .btn-book-inline { display:none; }
    
    .appt-card {
        background: linear-gradient(135deg, #c31432, #ef473a); padding: 22px; border-radius: 16px;
        box-shadow: 0 18px 40px rgba(0,0,0,0.15); margin-bottom: 18px;
        transition: transform 0.2s; position: relative;
        border: 1px solid rgba(255,255,255,0.15);
        animation: fadeInUp 0.35s ease;
        color: #fff;
    }
    .appt-card:hover { transform: translateY(-3px); box-shadow: 0 14px 40px rgba(0,0,0,0.25); }
    
    .appt-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
    .doctor-info h3 { margin: 0; font-size: 1.2rem; color: #fff; }
    .appt-time { color: #ffe0cf; font-weight: 700; font-size: 0.95rem; margin-top: 5px; }
    
    .status-pill {
        padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase;
        background: rgba(255,255,255,0.2); color: #fff; border: 1px solid rgba(255,255,255,0.25);
    }
    .pill-pending { background-color: rgba(255,193,7,0.28); color: #fff4d0; }
    .pill-approved { background-color: rgba(40,167,69,0.28); color: #dffce7; }
    .pill-cancelled { background-color: rgba(220,53,69,0.28); color: #ffe1e6; }

    /* Cancellation Form */
    .cancel-area {
        margin-top: 20px; padding-top: 15px; border-top: 1px dashed #eee;
    }
    .cancel-form { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .reason-select {
        padding: 10px; border: 1px solid rgba(255,255,255,0.25); border-radius: 10px; outline: none; flex: 1;
        background: rgba(255,255,255,0.08); color: #fff;
    }
    .btn-confirm-cancel {
        background: linear-gradient(120deg, #ffffff, #ffe0e0); color: #c31432; border: none; padding: 10px 20px;
        border-radius: 10px; cursor: pointer; font-weight: 700;
    }
    .btn-toggle-cancel {
        background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.4); color: #fff;
        padding: 8px 16px; border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.3s;
    }
    .btn-toggle-cancel:hover { background: rgba(255,255,255,0.25); }

    /* Sidebar styled like admin */
    .sidebar {
      width: 240px;
      background: #fff;
      color: #fff;
      padding: 24px 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      border-right: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 18px 38px rgba(0,0,0,0.18);
      position: relative;
      overflow: hidden;
    }
    .sidebar::before {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: url("{% static 'main/img/womandoctor.png' %}") no-repeat center center;
      background-size: cover;
      opacity: 0.28;
      pointer-events: none;
      z-index: 0;
    }
    .logo { font-weight: 800; font-size: 20px; letter-spacing: 0.4px; text-align:center; z-index:1; }
    .logo img { width: 140px; display:block; margin:0 auto; filter: drop-shadow(0 6px 10px rgba(0,0,0,0.25)); position: relative; z-index:1; }

    .nav a {
      color: #fff;
      background: #ad0505;
      border: 1px solid rgba(0,0,0,0.08);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      border-radius: 12px;
      font-weight: 700;
      position: relative;
      overflow: hidden;
      transition: background 0.25s, transform 0.22s ease, box-shadow 0.22s ease;
      z-index:1;
      box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }
    .nav a::before {
      content:"";
      width: 18px;
      height: 18px;
      border-radius: 6px;
      background: #7a0000;
      display: inline-block;
      flex-shrink: 0;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.25));
    }

    .nav a:hover,
    .nav a:focus {
      background: linear-gradient(to right, #ff7b00, #d10000);
      transform: translateX(6px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.18);
    }
    .nav a.active {
      background: linear-gradient(to right, #d10000, #a30000);
      transform: translateX(3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }

    /* Responsive & orientation handling */
    @media (max-width: 1100px) {
      .content { padding: 24px; }
      .top-header { padding: 14px 18px; flex-wrap: wrap; gap: 12px; }
      .header-actions { width: 100%; justify-content: flex-start; gap: 16px; }
      .stats-container { flex-wrap: wrap; }
      .stat-box { min-width: 240px; }
    }

    @media (max-width: 900px) {
      .dashboard-wrap { flex-direction: column; }
      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        gap: 12px;
        padding: 16px 14px;
      }
      .nav ul { display: flex; flex-wrap: wrap; gap: 10px; padding: 0; margin: 0; }
      .nav li { margin: 0; }
      .nav a { padding: 10px 12px; }
      .content { padding: 20px; }
      .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; }
      .top-header { flex-direction: column; align-items: flex-start; }
      .appt-header { flex-direction: column; align-items: flex-start; gap: 8px; }
    }

    @media (max-width: 640px) {
      .welcome-section h2 { font-size: 1.3rem; }
      .btn-book-new { width: 100%; text-align: center; }
      .notif-dropdown { width: 260px; }
      .stats-container { grid-template-columns: 1fr; }
      .nav a { width: 100%; }
    }

    @media (orientation: landscape) and (max-width: 900px) {
      .sidebar { flex-wrap: wrap; justify-content: space-between; }
      .nav ul { justify-content: flex-start; }
    }

    .logo img { width: 200px; display: block; margin: 0 auto; }

    /* Avatar + welcome */
    .welcome-row { display:flex; align-items:center; gap:12px; }
    .avatar {
      width: 46px; height: 46px; border-radius: 14px; overflow:hidden;
      border: 2px solid rgba(255,255,255,0.18);
      box-shadow: 0 10px 28px rgba(0,0,0,0.32);
      background: rgba(255,255,255,0.06);
      flex-shrink:0;
    }
    .avatar img { width:100%; height:100%; object-fit:cover; display:block; }

    /* Animations */
    @keyframes dropdownFade { from { opacity:0; transform: translateY(-6px);} to { opacity:1; transform: translateY(0);} }
    @keyframes fadeIn { from { opacity:0; transform: translateY(-6px);} to { opacity:1; transform: translateY(0);} }
    @keyframes fadeInUp { from { opacity:0; transform: translateY(10px);} to { opacity:1; transform: translateY(0);} }
    @keyframes shimmer { to { transform: translateX(140%); } }
  </style>

  <script>
    function toggleNotifications() {
        const menu = document.getElementById("notificationMenu");
        if (menu.style.display === "block") {
            menu.style.display = "none";
        } else {
            menu.style.display = "block";
        }
    }

    // Close dropdown if clicking outside
    document.addEventListener("click", function(event) {
        const bell = document.getElementById("notifBtn");
        const menu = document.getElementById("notificationMenu");
        if (!bell.contains(event.target) && !menu.contains(event.target)) {
            menu.style.display = "none";
        }
    });
  </script>
</head>
<body>

<div class="dashboard-wrap">
    
    <aside class="sidebar">
      <div class="logo">
        <div class="logo">
            <img src="{% static 'main/img/medlink.png' %}" alt="MedLink logo">
          </div>
      </div>
      <nav class="nav">
        <ul>
          <li><a href="{% url 'user_dashboard' %}" style="color:white; font-weight:bold;">Dashboard</a></li>
          <li><a href="{% url 'user_profile' %}">Profile</a></li>
          <li><a href="{% url 'appointment_history' %}">History</a></li> 
          <li>
            <a href="{% url 'logout' %}" onclick="return confirm('Are you sure you want to log out?');">
                Logout
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <main class="content">

        <div class="top-header">
            <div class="welcome-section">
                <div class="welcome-row">
                  <div class="avatar">
                    {% if profile_image %}
                      <img src="{{ profile_image }}" alt="Profile">
                    {% elif request.session.profile_image %}
                      <img src="{{ request.session.profile_image }}" alt="Profile">
                    {% else %}
                      <img src="{% static 'main/img/person.png' %}" alt="Profile">
                    {% endif %}
                  </div>
                  <div>
                    <h2>Hello, {{ first_name|default:"User" }}!</h2>
                    <p>Track your appointments and health status.</p>
                  </div>
                </div>
            </div>

            <div class="header-actions">
                <div class="notif-wrapper">
                    <button id="notifBtn" class="notif-btn" onclick="toggleNotifications()">
                        <i class="fa fa-bell"></i>
                        {% if status_notifications %}
                            <span class="notif-badge"></span>
                        {% endif %}
                    </button>

                    <div id="notificationMenu" class="notif-dropdown">
                        <div class="notif-header">Recent Updates</div>
                        {% if status_notifications %}
                            {% for note in status_notifications %}
                                <div class="notif-item">
                                    <span class="notif-status 
                                        {% if note.status == 'Approved' %}status-approved-text{% endif %}
                                        {% if note.status == 'Cancelled' %}status-cancelled-text{% endif %}
                                        {% if note.status == 'Declined' %}status-cancelled-text{% endif %} 
                                        {% if note.status == 'Pending' %}status-pending-text{% endif %}">
                                        {{ note.status }}
                                    </span>
                                    <span>Dr. {{ note.doctor_name }}</span>
                                    <span style="font-size:0.8rem; color:#888;">{{ note.appointment_date }}</span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="notif-empty">No new notifications</div>
                        {% endif %}
                    </div>
                </div>

                <a href="{% url 'book_appointment' %}" class="btn-book-new">+ Book Appointment</a>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-box pending">
                <div class="stat-info">
                    <h4>Pending</h4>
                    <p class="count">{{ pending_count }}</p>
                </div>
                <a href="{% url 'appointment_history' %}?status=Pending" class="stat-link">➝</a>
            </div>
            <div class="stat-box completed">
                <div class="stat-info">
                    <h4>Completed</h4>
                    <p class="count">{{ completed_count }}</p>
                </div>
                <a href="{% url 'appointment_history' %}?status=Completed" class="stat-link">➝</a>
            </div>
            <div class="stat-box total">
                <div class="stat-info">
                    <h4>Total Visits</h4>
                    <p class="count">{{ total_count }}</p>
                </div>
                <a href="{% url 'appointment_history' %}" class="stat-link">➝</a>
            </div>
        </div>

        {% if reminders %}
            {% for reminder in reminders %}
            <div class="reminder-alert">
                <div class="reminder-icon">⏰</div>
                <div>
                    <strong>Upcoming Reminder:</strong> Appointment with 
                    <strong>Dr. {{ reminder.doctor_name }}</strong> on 
                    {{ reminder.appointment_date }} at {{ reminder.appointment_time }}.
                </div>
            </div>
            {% endfor %}
        {% endif %}

        {% if messages %}
            {% for message in messages %}
                <div class="message-box" style="margin-bottom: 20px;">{{ message }}</div>
            {% endfor %}
        {% endif %}

        <div class="section-header">
          <h3 class="section-title">Your Upcoming Appointments</h3>
          <a href="{% url 'book_appointment' %}" class="btn-book-inline">Book Now</a>
        </div>
        
        <div class="appt-list">
            {% if appointments %}
                {% for appt in appointments %}
                <div class="appt-card">
                    
                    <div class="appt-header">
                        <div class="doctor-info">
                            <h3>Dr. {{ appt.doctor_name }}</h3>
                            <div class="appt-time">
                                <i class="fa fa-calendar"></i> {{ appt.appointment_date }} &nbsp; 
                                <i class="fa fa-clock"></i> {{ appt.appointment_time }}
                            </div>
                        </div>
                        <div>
                            <span class="status-pill 
                                {% if appt.status == 'Pending' %}pill-pending{% endif %}
                                {% if appt.status == 'Approved' %}pill-approved{% endif %}">
                                {{ appt.status }}
                            </span>
                        </div>
                    </div>

                    {% if appt.status == 'Pending' or appt.status == 'Approved' %}
                    <div class="cancel-area">
                        
                        <button type="button" class="btn-toggle-cancel"
                                onclick="document.getElementById('cancel-panel-{{ appt.id }}').style.display = 'flex'; this.style.display='none';">
                            Cancel Appointment
                        </button>

                        <form id="cancel-panel-{{ appt.id }}" class="cancel-form" method="POST" 
                              action="{% url 'user_cancel_appointment' appt.id %}" 
                              style="display: none;">
                            {% csrf_token %}
                            
                            <label style="font-size: 0.9rem; font-weight: bold; color: #555;">Reason:</label>
                            <select name="reason" class="reason-select" required>
                                <option value="" disabled selected>Select a reason...</option>
                                <option value="Schedule Conflict">Schedule Conflict</option>
                                <option value="Feeling Better">Feeling Better</option>
                                <option value="Emergency">Emergency</option>
                                <option value="Found Another Doctor">Found Another Doctor</option>
                                <option value="Other">Other</option>
                            </select>

                            <button type="submit" class="btn-confirm-cancel">Confirm</button>
                            
                            <button type="button" style="background:none; border:none; color:#999; cursor:pointer; text-decoration:underline; font-size:0.9rem;"
                                    onclick="document.getElementById('cancel-panel-{{ appt.id }}').style.display = 'none'; this.closest('.cancel-area').querySelector('.btn-toggle-cancel').style.display = 'inline-block';">
                                Go Back
                            </button>
                        </form>
                    </div>
                    {% endif %}

                </div>
                {% endfor %}
            {% else %}
                <div class="no-appointments">
                    <p>You have no upcoming appointments.</p>
                    <a href="{% url 'book_appointment' %}" class="btn-book-new">Book Now</a>
                </div>
            {% endif %}
        </div>

    </main>
</div>

</body>
</html>