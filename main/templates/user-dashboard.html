{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>User Dashboard</title>
  
  <link rel="stylesheet" href="{% static 'main/css/admin_dashboard.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    /* --- Modern UI Overrides --- */
    body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    .dashboard-wrap { display: flex; min-height: 100vh; }
    .content { flex: 1; padding: 30px; }

    /* 1. TOP NAV BAR */
    .top-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        padding: 15px 30px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        margin-bottom: 30px;
    }

    .welcome-section h2 { margin: 0; font-size: 1.6rem; color: #2c3e50; }
    .welcome-section p { margin: 5px 0 0; color: #7f8c8d; font-size: 0.95rem; }

    .header-actions { display: flex; align-items: center; gap: 25px; }

    /* Bell Icon & Dropdown */
    .notif-wrapper { position: relative; }
    
    .notif-btn {
        background: none; border: none; font-size: 1.4rem; cursor: pointer;
        color: #555; position: relative; transition: color 0.3s;
    }
    .notif-btn:hover { color: #007bff; }

    .notif-badge {
        position: absolute; top: -2px; right: -2px;
        width: 9px; height: 9px; background: #dc3545;
        border-radius: 50%; border: 2px solid white;
    }

    .notif-dropdown {
        display: none;
        position: absolute; right: 0; top: 45px;
        width: 300px; background: white;
        border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        z-index: 1000; overflow: hidden; border: 1px solid #eee;
    }
    
    .notif-header {
        padding: 12px 15px; background: #f8f9fa; border-bottom: 1px solid #eee;
        font-weight: bold; color: #555; font-size: 0.9rem;
    }

    .notif-item {
        padding: 15px; border-bottom: 1px solid #f1f1f1;
        font-size: 0.9rem; color: #444; display: flex; flex-direction: column; gap: 4px;
    }
    .notif-item:last-child { border-bottom: none; }
    .notif-item:hover { background-color: #fafafa; }
    
    .notif-status { font-weight: bold; font-size: 0.85rem; text-transform: uppercase; }
    .status-approved-text { color: #28a745; }
    .status-cancelled-text { color: #dc3545; } /* Used for Cancelled AND Declined */
    .status-pending-text { color: #ffc107; }

    .notif-empty { padding: 20px; text-align: center; color: #999; font-style: italic; }

    /* Action Button */
    .btn-book-new {
        background-color: #007bff; color: white; padding: 12px 24px;
        border-radius: 8px; text-decoration: none; font-weight: 600;
        box-shadow: 0 4px 10px rgba(0, 123, 255, 0.2); transition: transform 0.2s;
    }
    .btn-book-new:hover { transform: translateY(-2px); background-color: #0069d9; }

    /* Stat Cards */
    .stats-container { display: flex; gap: 20px; margin-bottom: 30px; }
    .stat-box {
        flex: 1; background: white; padding: 25px; border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex;
        justify-content: space-between; align-items: center;
        border-left: 5px solid transparent;
    }
    .stat-box.pending { border-left-color: #ffc107; }
    .stat-box.completed { border-left-color: #28a745; }
    .stat-box.total { border-left-color: #6c757d; }

    .stat-info h4 { margin: 0 0 5px; font-size: 1rem; color: #888; font-weight: 600; }
    .stat-info .count { font-size: 2rem; font-weight: 800; color: #333; margin: 0; }
    .stat-link {
        width: 40px; height: 40px; border-radius: 50%; background: #f0f2f5;
        display: flex; align-items: center; justify-content: center;
        color: #555; text-decoration: none; transition: 0.3s;
    }
    .stat-link:hover { background: #e2e6ea; color: #007bff; }

    /* Appointment Cards */
    .section-title { font-size: 1.3rem; margin-bottom: 20px; color: #333; font-weight: 700; }
    
    .appt-card {
        background: white; padding: 25px; border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px;
        transition: transform 0.2s; position: relative;
        border: 1px solid #f0f0f0;
    }
    .appt-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
    
    .appt-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
    .doctor-info h3 { margin: 0; font-size: 1.2rem; color: #2c3e50; }
    .appt-time { color: #007bff; font-weight: 600; font-size: 0.95rem; margin-top: 5px; }
    
    .status-pill {
        padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase;
    }
    .pill-pending { background-color: #fff3cd; color: #856404; }
    .pill-approved { background-color: #d4edda; color: #155724; }
    .pill-cancelled { background-color: #f8d7da; color: #721c24; }

    /* Cancellation Form */
    .cancel-area {
        margin-top: 20px; padding-top: 15px; border-top: 1px dashed #eee;
    }
    .cancel-form { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .reason-select {
        padding: 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; flex: 1;
    }
    .btn-confirm-cancel {
        background: #dc3545; color: white; border: none; padding: 10px 20px;
        border-radius: 8px; cursor: pointer; font-weight: 600;
    }
    .btn-toggle-cancel {
        background: white; border: 1px solid #ffc107; color: #d39e00;
        padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s;
    }
    .btn-toggle-cancel:hover { background: #fff3cd; }

    /* Sidebar adjustments */
    .sidebar { background: #dc3545; } /* Keeping your red theme */
    .nav a { color: rgba(255,255,255,0.8); }
    .nav a:hover { background: rgba(255,255,255,0.1); color: white; }

  </style>

  <script>
    function toggleNotifications() {
        const menu = document.getElementById("notificationMenu");
        if (menu.style.display === "block") {
            menu.style.display = "none";
        } else {
            menu.style.display = "block";
        }
    }

    // Close dropdown if clicking outside
    document.addEventListener("click", function(event) {
        const bell = document.getElementById("notifBtn");
        const menu = document.getElementById("notificationMenu");
        if (!bell.contains(event.target) && !menu.contains(event.target)) {
            menu.style.display = "none";
        }
    });
  </script>
</head>
<body>

<div class="dashboard-wrap">
    
    <aside class="sidebar">
      <div class="logo">MedLink</div>
      <nav class="nav">
        <ul>
          <li><a href="{% url 'user_dashboard' %}" style="color:white; font-weight:bold;">Dashboard</a></li>
          <li><a href="{% url 'user_profile' %}">Profile</a></li>
          <li><a href="{% url 'appointment_history' %}">History</a></li> 
          <li>
            <a href="{% url 'logout' %}" onclick="return confirm('Are you sure you want to log out?');">
                Logout
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <main class="content">

        <div class="top-header">
            <div class="welcome-section">
                <h2>Hello, {{ first_name|default:"User" }}! üëã</h2>
                <p>Track your appointments and health status.</p>
            </div>

            <div class="header-actions">
                <div class="notif-wrapper">
                    <button id="notifBtn" class="notif-btn" onclick="toggleNotifications()">
                        <i class="fa fa-bell"></i>
                        {% if status_notifications %}
                            <span class="notif-badge"></span>
                        {% endif %}
                    </button>

                    <div id="notificationMenu" class="notif-dropdown">
                        <div class="notif-header">Recent Updates</div>
                        {% if status_notifications %}
                            {% for note in status_notifications %}
                                <div class="notif-item">
                                    <span class="notif-status 
                                        {% if note.status == 'Approved' %}status-approved-text{% endif %}
                                        {% if note.status == 'Cancelled' %}status-cancelled-text{% endif %}
                                        {% if note.status == 'Declined' %}status-cancelled-text{% endif %} 
                                        {% if note.status == 'Pending' %}status-pending-text{% endif %}">
                                        {{ note.status }}
                                    </span>
                                    <span>Dr. {{ note.doctor_name }}</span>
                                    <span style="font-size:0.8rem; color:#888;">{{ note.appointment_date }}</span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="notif-empty">No new notifications</div>
                        {% endif %}
                    </div>
                </div>

                <a href="{% url 'book_appointment' %}" class="btn-book-new">+ Book Appointment</a>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-box pending">
                <div class="stat-info">
                    <h4>Pending</h4>
                    <p class="count">{{ pending_count }}</p>
                </div>
                <a href="{% url 'appointment_history' %}?status=Pending" class="stat-link">‚ûù</a>
            </div>
            <div class="stat-box completed">
                <div class="stat-info">
                    <h4>Completed</h4>
                    <p class="count">{{ completed_count }}</p>
                </div>
                <a href="{% url 'appointment_history' %}?status=Completed" class="stat-link">‚ûù</a>
            </div>
            <div class="stat-box total">
                <div class="stat-info">
                    <h4>Total Visits</h4>
                    <p class="count">{{ total_count }}</p>
                </div>
                <a href="{% url 'appointment_history' %}" class="stat-link">‚ûù</a>
            </div>
        </div>

        {% if reminders %}
            {% for reminder in reminders %}
            <div class="reminder-alert">
                <div class="reminder-icon">‚è∞</div>
                <div>
                    <strong>Upcoming Reminder:</strong> Appointment with 
                    <strong>Dr. {{ reminder.doctor_name }}</strong> on 
                    {{ reminder.appointment_date }} at {{ reminder.appointment_time }}.
                </div>
            </div>
            {% endfor %}
        {% endif %}

        {% if messages %}
            {% for message in messages %}
                <div class="message-box" style="margin-bottom: 20px;">{{ message }}</div>
            {% endfor %}
        {% endif %}

        <h3 class="section-title">Your Upcoming Appointments</h3>
        
        <div class="appt-list">
            {% if appointments %}
                {% for appt in appointments %}
                <div class="appt-card">
                    
                    <div class="appt-header">
                        <div class="doctor-info">
                            <h3>Dr. {{ appt.doctor_name }}</h3>
                            <div class="appt-time">
                                <i class="fa fa-calendar"></i> {{ appt.appointment_date }} &nbsp; 
                                <i class="fa fa-clock"></i> {{ appt.appointment_time }}
                            </div>
                        </div>
                        <div>
                            <span class="status-pill 
                                {% if appt.status == 'Pending' %}pill-pending{% endif %}
                                {% if appt.status == 'Approved' %}pill-approved{% endif %}">
                                {{ appt.status }}
                            </span>
                        </div>
                    </div>

                    {% if appt.status == 'Pending' or appt.status == 'Approved' %}
                    <div class="cancel-area">
                        
                        <button type="button" class="btn-toggle-cancel"
                                onclick="document.getElementById('cancel-panel-{{ appt.id }}').style.display = 'flex'; this.style.display='none';">
                            Cancel Appointment
                        </button>

                        <form id="cancel-panel-{{ appt.id }}" class="cancel-form" method="POST" 
                              action="{% url 'user_cancel_appointment' appt.id %}" 
                              style="display: none;">
                            {% csrf_token %}
                            
                            <label style="font-size: 0.9rem; font-weight: bold; color: #555;">Reason:</label>
                            <select name="reason" class="reason-select" required>
                                <option value="" disabled selected>Select a reason...</option>
                                <option value="Schedule Conflict">Schedule Conflict</option>
                                <option value="Feeling Better">Feeling Better</option>
                                <option value="Emergency">Emergency</option>
                                <option value="Found Another Doctor">Found Another Doctor</option>
                                <option value="Other">Other</option>
                            </select>

                            <button type="submit" class="btn-confirm-cancel">Confirm</button>
                            
                            <button type="button" style="background:none; border:none; color:#999; cursor:pointer; text-decoration:underline; font-size:0.9rem;"
                                    onclick="document.getElementById('cancel-panel-{{ appt.id }}').style.display = 'none'; this.closest('.cancel-area').querySelector('.btn-toggle-cancel').style.display = 'inline-block';">
                                Go Back
                            </button>
                        </form>
                    </div>
                    {% endif %}

                </div>
                {% endfor %}
            {% else %}
                <div class="no-appointments">
                    <p>You have no upcoming appointments.</p>
                    <a href="{% url 'book_appointment' %}" class="btn-book-new">Book Now</a>
                </div>
            {% endif %}
        </div>

    </main>
</div>

</body>
</html>